# AgentSDK 架构概览

> **设计原则**: 模块化、可扩展、框架无关  
> **最后更新**: 2024年11月17日

---

## 整体架构

AgentSDK 采用四层架构设计，将后端核心、Server 层、HTTP 层和客户端 SDK 完全解耦：

```
┌─────────────────────────────────────────────────────────────────┐
│                      Client Layer                                │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │        Client SDKs (多语言、多框架支持)                   │   │
│  │  ┌──────────┬──────────┬──────────┬──────────┐          │   │
│  │  │client-js │  React   │ AI SDK   │   Vue    │          │   │
│  │  │(核心)    │ (集成)   │(Vercel)  │(未来)    │          │   │
│  │  └──────────┴──────────┴──────────┴──────────┘          │   │
│  │  • 15 个资源模块 • 事件驱动 • 类型安全                    │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                         │ HTTP/WebSocket
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│            ✨ Server Layer (server/) - 生产级                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Production Server (企业级特性)               │   │
│  │  ┌────────────┬────────────┬────────────┬──────────┐    │   │
│  │  │ Auth &     │Observability│ Rate      │ Handlers │    │   │
│  │  │ RBAC       │(Metrics+   │ Limiting  │ (8 core) │    │   │
│  │  │(API Key+JWT)│ Tracing)   │(Token/SW) │          │    │   │
│  │  └────────────┴────────────┴────────────┴──────────┘    │   │
│  │  • 认证授权 • Prometheus • OpenTelemetry • 健康检查      │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                         │ OR (任选其一)
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              HTTP Layer (cmd/agentsdk) - 开发工具                │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │           Development Server (快速启动)                   │   │
│  │  • Gin HTTP Server  • REST API  • WebSocket              │   │
│  │  • 可替换为任何框架 (Echo, Chi, 标准库等)                 │   │
│  │  • 简化配置 • 无认证 • 快速迭代                           │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                         │ 纯 Go 接口调用
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Core Layer (pkg/)                           │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  AgentSDK 核心                            │   │
│  │  ┌───────────────────────────────────────────────────┐   │   │
│  │  │           Agent Types (灵活编排)                   │   │   │
│  │  │  • Basic Agent  • Workflow  • SubAgent            │   │   │
│  │  └───────────────────────────────────────────────────┘   │   │
│  │  ┌───────────────────────────────────────────────────┐   │   │
│  │  │      Middleware Stack (洋葱模型)                  │   │   │
│  │  │  • Summarization • Filesystem • SubAgent          │   │   │
│  │  └───────────────────────────────────────────────────┘   │   │
│  │  ┌───────────────────────────────────────────────────┐   │   │
│  │  │         Backend Abstraction (存储抽象)            │   │   │
│  │  │  • State  • Store  • Filesystem  • Composite      │   │   │
│  │  └───────────────────────────────────────────────────┘   │   │
│  │  • 零 HTTP 框架依赖  • 纯业务逻辑  • 可被任何项目导入    │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 核心设计原则

### 1. 框架无关 (Framework Agnostic)

**pkg/ 核心 SDK**:
- ✅ 零 HTTP 框架依赖
- ✅ 只依赖 Go 标准库和核心第三方库
- ✅ 可被任何项目安全导入
- ✅ 不强制用户使用特定框架

**cmd/ HTTP 层**:
- 可以使用任何 HTTP 框架 (Gin, Echo, Chi, 标准库等)
- 用户可以完全替换 HTTP 实现
- 只是一个参考实现

### 2. 分层架构 (Layered Architecture)

```
依赖方向: Client → Server/HTTP → Core
职责分离: 展示层 → 服务层 → 接口层 → 业务层
```

**四层职责**:
- **Client 层**: UI/UX、事件处理、状态管理
- **Server 层**: 认证、授权、监控、限流（生产环境）
- **HTTP 层**: 路由、序列化、协议转换（开发环境）
- **Core 层**: Agent 逻辑、Middleware、存储抽象

### 3. 模块化设计 (Modular Design)

**15 个功能域**:
- Agent、Memory、Workflow、Session
- Tool、Skill、Eval、MCP
- Router、Sandbox、Middleware、Telemetry
- Provider、Template、Security

每个模块独立，可按需使用。

### 4. 事件驱动 (Event-Driven)

**三通道设计**:
- **Progress Channel**: 数据流 (thinking, text_chunk, tool_*)
- **Control Channel**: 审批流 (tool_approval, pause/resume)
- **Monitor Channel**: 治理流 (token_usage, cost, compliance)

---

## 关键特性

### 核心 SDK (pkg/)

- ✅ **Agent 类型**: Basic、Workflow (Parallel/Sequential/Loop)、SubAgent
- ✅ **Middleware 栈**: 洋葱模型、优先级排序、8+ 内置中间件
- ✅ **Backend 抽象**: State、Store、Filesystem、Composite
- ✅ **Session Store**: Memory、PostgreSQL、MySQL 8.0+
- ✅ **工具系统**: 7+ 内置工具、长时运行支持
- ✅ **性能优化**: ~27M ops/s (Middleware)、~3.8M ops/s (Backend)

### HTTP 服务 (cmd/agentsdk)

- ✅ **100+ API 端点**: 完整的 REST API
- ✅ **流式响应**: SSE、WebSocket
- ✅ **事件订阅**: 三通道实时事件
- ✅ **认证授权**: API Key、OAuth 2.0
- ✅ **可观测性**: OpenTelemetry 集成

### 客户端 SDK (client-sdks)

- ✅ **15 个资源模块**: 按功能域组织
- ✅ **事件驱动**: 20+ 事件类型
- ✅ **类型安全**: 完整的 TypeScript 类型
- ✅ **BaseResource**: 自动 Retry、错误处理、日志追踪
- ✅ **框架集成**: React、Vercel AI SDK、Vue (未来)

---

## 使用方式

### 作为 Go SDK 使用

```go
import (
    "github.com/wordflowlab/agentsdk/pkg/agent"
    "github.com/wordflowlab/agentsdk/pkg/store"
    // 不会引入任何 HTTP 框架！
)

func main() {
    store, _ := store.NewJSONStore(".data")
    deps := &agent.Dependencies{Store: store}
    config := &types.AgentConfig{TemplateID: "assistant"}
    
    ag, _ := agent.Create(context.Background(), config, deps)
    result, _ := ag.Chat(context.Background(), "Hello!")
    println(result.Text)
}
```

### 作为 HTTP 服务使用

```bash
# 使用内置的 Gin 实现
./agentsdk serve --addr :8080

# 或自己实现 HTTP 层（用任何框架）
```

### 作为客户端 SDK 使用

```typescript
import { AgentsdkClient } from '@agentsdk/client-js';

const client = new AgentsdkClient({
  baseURL: 'http://localhost:8080',
  apiKey: 'your-api-key'
});

// 使用任意资源
const response = await client.agents.chat({
  input: 'Hello, world!'
});

// 流式响应
for await (const event of client.agents.stream({ input: '...' })) {
  console.log(event);
}

// 事件订阅
const sub = await client.agents.subscribe(['progress', 'control']);
for await (const event of sub) {
  console.log(event);
}
```

---

## 对比其他框架

| 特性 | AgentSDK | LangChain | CrewAI |
|------|----------|-----------|--------|
| **语言** | Go + TypeScript | Python | Python |
| **架构** | 三层解耦 | 单体 | 单体 |
| **框架依赖** | 零依赖 (核心) | 强依赖 | 强依赖 |
| **性能** | 极高 (Go) | 中等 | 中等 |
| **事件驱动** | ✅ 三通道 | ❌ | ❌ |
| **Middleware** | ✅ 洋葱模型 | ✅ | ❌ |
| **类型安全** | ✅ 完整 | ❌ | ❌ |
| **可扩展性** | ✅ 极强 | ✅ | ⚠️ |

---

## 相关文档

- [核心 SDK 架构](./2.core-sdk.md) - pkg/ 详细设计
- [HTTP 层架构](./3.http-layer.md) - cmd/agentsdk 设计
- [客户端 SDK 架构](./4.client-sdk.md) - client-sdks 设计
- [扩展指南](./5.extensions.md) - 如何扩展 AgentSDK

---

**版本**: v2.0  
**最后更新**: 2024年11月17日
