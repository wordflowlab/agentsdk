---
title: Agentç”Ÿå‘½å‘¨æœŸ
description: æ·±å…¥ç†è§£Agentçš„åˆ›å»ºã€è¿è¡Œå’Œé”€æ¯è¿‡ç¨‹
navigation:
  icon: i-lucide-refresh-cw
---

# Agentç”Ÿå‘½å‘¨æœŸ

AgentSDKçš„Agentéµå¾ªæ¸…æ™°çš„ç”Ÿå‘½å‘¨æœŸæ¨¡å‹ï¼Œä»åˆ›å»ºåˆ°é”€æ¯ç»å†å¤šä¸ªé˜¶æ®µã€‚ç†è§£ç”Ÿå‘½å‘¨æœŸå¯¹äºæ­£ç¡®ä½¿ç”¨å’Œæ‰©å±•AgentSDKè‡³å…³é‡è¦ã€‚

## ğŸ”„ ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Create     â”‚  åˆ›å»ºAgentå®ä¾‹
â”‚  (å‡†å¤‡é˜¶æ®µ)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Start      â”‚  å¯åŠ¨Agentï¼ˆå¯é€‰æ˜¾å¼è°ƒç”¨ï¼‰
â”‚  (åˆå§‹åŒ–)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Running     â”‚  æ‰§è¡Œå¯¹è¯
â”‚ (Chat/Send)  â”‚  â—„â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
       â”‚                 â”‚ å¾ªç¯
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚  â”‚
       â”‚  â–¼
       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ â”‚ Processing  â”‚  å¤„ç†æ¶ˆæ¯
       â”‚ â”‚ (å†…éƒ¨å¾ªç¯)  â”‚
       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚       â”‚
       â”‚       â–¼
       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ â”‚Tool Execute â”‚  æ‰§è¡Œå·¥å…·
       â”‚ â”‚(å¯é€‰)       â”‚
       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Close     â”‚  å…³é—­Agent
â”‚  (æ¸…ç†èµ„æº)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ Createé˜¶æ®µ

### åˆ›å»ºAgent

```go
ag, err := agent.Create(context.Background(), &types.AgentConfig{
    TemplateID: "assistant",
    ModelConfig: &types.ModelConfig{
        Provider: "anthropic",
        Model:    "claude-sonnet-4-5",
        APIKey:   os.Getenv("ANTHROPIC_API_KEY"),
    },
    Sandbox: &types.SandboxConfig{
        Kind:    types.SandboxKindLocal,
        WorkDir: "./workspace",
    },
}, deps)
```

### åˆ›å»ºæ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

1. **éªŒè¯é…ç½®**
   - æ£€æŸ¥å¿…éœ€å­—æ®µ
   - éªŒè¯æ¨¡æ¿ID
   - æ£€æŸ¥æ¨¡å‹Provider

2. **åˆå§‹åŒ–ä¾èµ–**
   - åˆ›å»ºå·¥å…·æ³¨å†Œè¡¨
   - åˆå§‹åŒ–å­˜å‚¨åç«¯
   - é…ç½®æ²™ç®±å·¥å‚

3. **æ³¨å†Œä¸­é—´ä»¶**
   - æŒ‰é…ç½®åŠ è½½ä¸­é—´ä»¶
   - æ„å»ºä¸­é—´ä»¶æ ˆï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
   - æ”¶é›†æ‰€æœ‰å·¥å…·

4. **åˆ›å»ºäº‹ä»¶ç³»ç»Ÿ**
   - åˆå§‹åŒ–ä¸‰ä¸ªäº‹ä»¶é€šé“
   - å¯åŠ¨äº‹ä»¶åˆ†å‘å™¨

5. **å‡†å¤‡Provider**
   - åˆå§‹åŒ–å¤§æ¨¡å‹å®¢æˆ·ç«¯
   - é…ç½®APIå¯†é’¥å’Œå‚æ•°

### é…ç½®è¯¦è§£

#### AgentConfig

```go
type AgentConfig struct {
    // Agentæ ‡è¯†
    ID         string  // å¯é€‰ï¼Œè‡ªåŠ¨ç”ŸæˆUUID
    TemplateID string  // æ¨¡æ¿ID

    // æ¨¡å‹é…ç½®
    ModelConfig *ModelConfig

    // æ²™ç®±é…ç½®
    Sandbox *SandboxConfig

    // ä¸­é—´ä»¶åˆ—è¡¨
    Middlewares []string

    // ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼Œè¦†ç›–æ¨¡æ¿ï¼‰
    SystemPrompt string

    // å·¥å…·é…ç½®
    Tools []interface{}  // å·¥å…·åç§°æˆ–å·¥å…·å®ä¾‹
}
```

#### Dependencies

```go
type Dependencies struct {
    // å¿…éœ€
    Store            Store             // æŒä¹…åŒ–å­˜å‚¨
    SandboxFactory   SandboxFactory    // æ²™ç®±å·¥å‚
    ToolRegistry     ToolRegistry      // å·¥å…·æ³¨å†Œè¡¨
    ProviderFactory  ProviderFactory   // Providerå·¥å‚
    TemplateRegistry TemplateRegistry  // æ¨¡æ¿æ³¨å†Œè¡¨

    // å¯é€‰
    MiddlewareRegistry MiddlewareRegistry  // ä¸­é—´ä»¶æ³¨å†Œè¡¨
}
```

## ğŸš€ Starté˜¶æ®µ

è™½ç„¶`Start`é€šå¸¸ä¸éœ€è¦æ˜¾å¼è°ƒç”¨ï¼ˆ`Chat`ä¼šè‡ªåŠ¨è°ƒç”¨ï¼‰ï¼Œä½†ç†è§£å®ƒå¾ˆé‡è¦ã€‚

### å¯åŠ¨æµç¨‹

```go
// é€šå¸¸ç”±Chatè‡ªåŠ¨è°ƒç”¨ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¾å¼å¯åŠ¨
ag.Start(ctx)
```

### Startæ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

1. **è§¦å‘ä¸­é—´ä»¶é’©å­**
   ```go
   for _, m := range middlewares {
       m.OnAgentStart(ctx, agentID)
   }
   ```

2. **åˆå§‹åŒ–æ¶ˆæ¯å†å²**
   - åŠ è½½ç³»ç»Ÿæç¤ºè¯
   - å¦‚æœæœ‰æŒä¹…åŒ–çŠ¶æ€ï¼Œæ¢å¤å†å²æ¶ˆæ¯

3. **å¯åŠ¨äº‹ä»¶ç›‘å¬**
   - å¼€å§‹ç›‘å¬æ§åˆ¶äº‹ä»¶
   - å‡†å¤‡æ¥æ”¶ç”¨æˆ·è¾“å…¥

## ğŸ’¬ Runningé˜¶æ®µ

è¿™æ˜¯Agentçš„ä¸»è¦å·¥ä½œé˜¶æ®µï¼ŒåŒ…å«ä¸¤ç§äº¤äº’æ¨¡å¼ã€‚

### æ¨¡å¼1ï¼šåŒæ­¥å¯¹è¯ï¼ˆChatï¼‰

é˜»å¡ç­‰å¾…å®Œæ•´å“åº”ï¼š

```go
result, err := ag.Chat(ctx, "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹Goè¯­è¨€")
if err != nil {
    log.Fatal(err)
}
fmt.Println(result.Text)
```

**Chatæµç¨‹**ï¼š

```
1. å‘é€ç”¨æˆ·æ¶ˆæ¯ â†’ Send()
2. è®¢é˜…Progressé€šé“
3. å¾ªç¯å¤„ç†äº‹ä»¶ç›´åˆ°å®Œæˆ
4. è¿”å›æœ€ç»ˆç»“æœ
```

### æ¨¡å¼2ï¼šå¼‚æ­¥æµå¼ï¼ˆSend + Subscribeï¼‰

éé˜»å¡ï¼Œå®æ—¶å¤„ç†äº‹ä»¶ï¼š

```go
// 1. è®¢é˜…äº‹ä»¶
eventCh := ag.Subscribe([]types.AgentChannel{
    types.ChannelProgress,
}, nil)

// 2. å¯åŠ¨äº‹ä»¶å¤„ç†
go func() {
    for envelope := range eventCh {
        switch e := envelope.Event.(type) {
        case *types.ProgressTextChunkEvent:
            fmt.Print(e.Delta)
        case *types.ProgressToolStartEvent:
            fmt.Printf("\n[Tool] %s\n", e.Call.Name)
        }
    }
}()

// 3. å‘é€æ¶ˆæ¯
ag.Send(ctx, "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹Goè¯­è¨€")
```

### å†…éƒ¨æ¶ˆæ¯å¤„ç†å¾ªç¯

```
User Message
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ processMessagesâ”‚  ä¸»å¤„ç†å¾ªç¯
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  runModelStep  â”‚  è°ƒç”¨æ¨¡å‹
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â–º Text Chunk â†’ ProgressTextChunkEvent
     â”‚
     â”œâ”€â–º Tool Call
     â”‚      â”‚
     â”‚      â–¼
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   â”‚ executeTools â”‚  æ‰§è¡Œå·¥å…·
     â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚          â”‚
     â”‚          â–¼
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   â”‚ Tool Result  â”‚
     â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚          â”‚
     â”‚          â””â”€â”€â”€â”€â”€â–º ç»§ç»­å¾ªç¯
     â”‚
     â””â”€â–º Stop Reason = "end_turn"
              â”‚
              â–¼
         ç»“æŸå¾ªç¯ï¼Œè¿”å›ç»“æœ
```

### æ¶ˆæ¯ç±»å‹

#### ç”¨æˆ·æ¶ˆæ¯

```go
ag.Send(ctx, "è¯·åˆ›å»ºä¸€ä¸ªhello.txtæ–‡ä»¶")
```

#### ç³»ç»Ÿæ¶ˆæ¯

```go
ag.SendSystemMessage(ctx, "å½“å‰æ—¶é—´æ˜¯ 2024-01-15 10:30")
```

#### å·¥å…·ç»“æœæ¶ˆæ¯ï¼ˆè‡ªåŠ¨ï¼‰

å·¥å…·æ‰§è¡Œå®Œæˆåè‡ªåŠ¨æ·»åŠ åˆ°å†å²ã€‚

## ğŸ› ï¸ Tool Execution

å·¥å…·æ‰§è¡Œæ˜¯Agentè¿è¡Œæ—¶çš„å…³é”®ç¯èŠ‚ã€‚

### å·¥å…·è°ƒç”¨æµç¨‹

```
1. æ¨¡å‹è¿”å›tool_useå—
     â”‚
     â–¼
2. æå–å·¥å…·è°ƒç”¨å‚æ•°
     â”‚
     â–¼
3. æŸ¥æ‰¾å·¥å…·å®šä¹‰
     â”‚
     â–¼
4. é€šè¿‡ä¸­é—´ä»¶æ ˆæ‰§è¡Œ
     â”‚  (WrapToolCallæ´‹è‘±æ¨¡å‹)
     â–¼
5. å·¥å…·Executeæ–¹æ³•
     â”‚
     â–¼
6. è¿”å›ç»“æœ
     â”‚
     â–¼
7. æ„é€ tool_resultæ¶ˆæ¯
     â”‚
     â–¼
8. ç»§ç»­æ¨¡å‹è°ƒç”¨
```

### å·¥å…·æ‰§è¡Œç¤ºä¾‹

```go
// æ¨¡å‹è¯·æ±‚
{
    "type": "tool_use",
    "id": "toolu_123",
    "name": "Write",
    "input": {
        "path": "/hello.txt",
        "content": "Hello World"
    }
}

// å·¥å…·æ‰§è¡Œ
tool := registry.GetTool("Write")
result, err := tool.Execute(ctx, input)

// æ„é€ å“åº”
{
    "type": "tool_result",
    "tool_use_id": "toolu_123",
    "content": "{\"ok\": true, \"path\": \"/hello.txt\"}"
}
```

### é”™è¯¯å¤„ç†

```go
// å·¥å…·åº”è¿”å›ç»“æ„åŒ–é”™è¯¯ï¼Œè€Œä¸æ˜¯Go error
if err != nil {
    return map[string]interface{}{
        "ok":    false,
        "error": "æ–‡ä»¶ä¸å­˜åœ¨",
        "path":  path,
    }, nil  // æ³¨æ„ï¼šè¿”å›nil error
}
```

è¿™æ ·LLMå¯ä»¥çœ‹åˆ°é”™è¯¯ä¿¡æ¯å¹¶å°è¯•æ¢å¤ã€‚

## ğŸ“¡ äº‹ä»¶å‘å¸ƒ

Agentåœ¨è¿è¡Œæ—¶å‘å¸ƒå„ç§äº‹ä»¶ã€‚

### Progressäº‹ä»¶

```go
// æ–‡æœ¬æµ
&types.ProgressTextChunkEvent{
    Delta: "éƒ¨åˆ†æ–‡æœ¬",
}

// å·¥å…·å¼€å§‹
&types.ProgressToolStartEvent{
    Call: ToolCall{
        ID:    "toolu_123",
        Name:  "Write",
        Input: map[string]interface{}{...},
    },
}

// å·¥å…·ç»“æŸ
&types.ProgressToolEndEvent{
    CallID: "toolu_123",
    Result: map[string]interface{}{...},
}
```

### Monitoräº‹ä»¶

```go
// é”™è¯¯äº‹ä»¶
&types.MonitorErrorEvent{
    Error:   err,
    Context: "æ¨¡å‹è°ƒç”¨å¤±è´¥",
}

// å·¥å…·æ‰§è¡Œå®¡è®¡
&types.MonitorToolExecutionEvent{
    ToolName: "Write",
    Duration: 15 * time.Millisecond,
    Success:  true,
}
```

### Controläº‹ä»¶

```go
// å·¥å…·å®¡æ‰¹è¯·æ±‚
&types.ControlToolApprovalRequest{
    ToolCall: call,
    Reason:   "éœ€è¦å®¡æ‰¹å†™æ“ä½œ",
}
```

## ğŸ”š Closeé˜¶æ®µ

ç»“æŸAgentç”Ÿå‘½å‘¨æœŸï¼Œæ¸…ç†èµ„æºã€‚

### å…³é—­Agent

```go
defer ag.Close()

// æˆ–æ˜¾å¼è°ƒç”¨
ag.Close()
```

### Closeæ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

1. **è§¦å‘ä¸­é—´ä»¶é’©å­**
   ```go
   for _, m := range middlewares {
       m.OnAgentStop(ctx, agentID)
   }
   ```

2. **å…³é—­äº‹ä»¶é€šé“**
   - åœæ­¢æ¥æ”¶æ–°äº‹ä»¶
   - å…³é—­æ‰€æœ‰è®¢é˜…é€šé“

3. **ä¿å­˜çŠ¶æ€**
   - å¦‚æœé…ç½®äº†æŒä¹…åŒ–ï¼Œä¿å­˜æ¶ˆæ¯å†å²
   - ä¿å­˜AgentçŠ¶æ€

4. **é‡Šæ”¾èµ„æº**
   - å…³é—­æ²™ç®±è¿æ¥
   - é‡Šæ”¾Providerèµ„æº
   - æ¸…ç†ä¸´æ—¶æ–‡ä»¶

### ä¼˜é›…å…³é—­

```go
// ä½¿ç”¨contextæ§åˆ¶è¶…æ—¶
ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
defer cancel()

// ç­‰å¾…å½“å‰æ“ä½œå®Œæˆ
result, err := ag.Chat(ctx, "æœ€åä¸€ä¸ªé—®é¢˜")

// å…³é—­
ag.Close()
```

## ğŸ”„ çŠ¶æ€ç®¡ç†

### AgentçŠ¶æ€

```go
type AgentState int

const (
    StateCreated   AgentState = iota  // å·²åˆ›å»º
    StateStarted                      // å·²å¯åŠ¨
    StateRunning                      // è¿è¡Œä¸­
    StateStopped                      // å·²åœæ­¢
    StateClosed                       // å·²å…³é—­
)
```

### çŠ¶æ€è½¬æ¢

```
Created â†’ Started â†’ Running âŸ· Running â†’ Stopped â†’ Closed
                       â†‘                    â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         (å¾ªç¯å¯¹è¯)
```

### æŸ¥è¯¢çŠ¶æ€

```go
state := ag.GetState()
if state == agent.StateRunning {
    log.Println("Agentæ­£åœ¨å¤„ç†æ¶ˆæ¯")
}
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å§‹ç»ˆdefer Close

```go
ag, err := agent.Create(ctx, config, deps)
if err != nil {
    log.Fatal(err)
}
defer ag.Close()  // âœ… ç¡®ä¿èµ„æºé‡Šæ”¾
```

### 2. ä½¿ç”¨contextæ§åˆ¶è¶…æ—¶

```go
ctx, cancel := context.WithTimeout(context.Background(), 5*time.Minute)
defer cancel()

result, err := ag.Chat(ctx, message)
```

### 3. å¼‚æ­¥å¤„ç†é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡

```go
// âœ… æ¨è
eventCh := ag.Subscribe(channels, nil)
go func() {
    for event := range eventCh {
        // å¤„ç†äº‹ä»¶
    }
}()

// âŒ ä¸æ¨èï¼ˆé˜»å¡ä¸»çº¿ç¨‹ï¼‰
result, _ := ag.Chat(ctx, longRunningTask)
```

### 4. æ­£ç¡®å¤„ç†é”™è¯¯

```go
result, err := ag.Chat(ctx, message)
if err != nil {
    // æ£€æŸ¥å…·ä½“é”™è¯¯ç±»å‹
    if errors.Is(err, context.DeadlineExceeded) {
        log.Println("è¶…æ—¶")
    } else {
        log.Printf("é”™è¯¯: %v", err)
    }
    return
}
```

### 5. å¤ç”¨Agentå®ä¾‹

```go
// âœ… æ¨èï¼šä¸€ä¸ªAgentå¤„ç†å¤šè½®å¯¹è¯
ag, _ := agent.Create(ctx, config, deps)
defer ag.Close()

ag.Chat(ctx, "ç¬¬ä¸€ä¸ªé—®é¢˜")
ag.Chat(ctx, "ç¬¬äºŒä¸ªé—®é¢˜")  // ä¿ç•™ä¸Šä¸‹æ–‡

// âŒ ä¸æ¨èï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°Agentï¼ˆä¸¢å¤±ä¸Šä¸‹æ–‡ï¼‰
for _, question := range questions {
    ag, _ := agent.Create(ctx, config, deps)
    ag.Chat(ctx, question)
    ag.Close()
}
```

## ğŸ“š ä¸‹ä¸€æ­¥

- [äº‹ä»¶ç³»ç»Ÿ](/core-concepts/event-system) - ç†è§£ä¸‰é€šé“äº‹ä»¶æ¶æ„
- [ä¸­é—´ä»¶ç³»ç»Ÿ](/core-concepts/middleware) - å­¦ä¹ æ´‹è‘±æ¨¡å‹
- [å·¥å…·ç³»ç»Ÿ](/core-concepts/tools-system) - åˆ›å»ºè‡ªå®šä¹‰å·¥å…·
- [å®æˆ˜æŒ‡å—](/guides/basic-agent) - å®Œæ•´é¡¹ç›®ç¤ºä¾‹

## ğŸ”— ç›¸å…³API

- [agent.Create](/api-reference/agent-api#create)
- [agent.Chat](/api-reference/agent-api#chat)
- [agent.Send](/api-reference/agent-api#send)
- [agent.Subscribe](/api-reference/agent-api#subscribe)
- [agent.Close](/api-reference/agent-api#close)
