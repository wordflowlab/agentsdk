---
title: äº‹ä»¶ç³»ç»Ÿ
description: ç†è§£AgentSDKçš„ä¸‰é€šé“äº‹ä»¶é©±åŠ¨æ¶æ„
navigation:
  icon: i-lucide-radio
---

# äº‹ä»¶ç³»ç»Ÿ

AgentSDKé‡‡ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œé€šè¿‡ä¸‰ä¸ªç‹¬ç«‹çš„äº‹ä»¶é€šé“åˆ†ç¦»ä¸åŒç±»å‹çš„ä¿¡æ¯æµï¼Œå®ç°æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»ã€‚

## ğŸ¯ ä¸‰é€šé“è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Agent Runtime               â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚       Progress Channel          â”‚â”€â”€â”€â”¼â”€â”€â–º UI/å‰ç«¯
â”‚  â”‚  (æ–‡æœ¬æµã€å·¥å…·æ‰§è¡Œè¿›åº¦)         â”‚   â”‚    å®æ—¶å±•ç¤º
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        Control Channel          â”‚â”€â”€â”€â”¼â”€â”€â–º å®¡æ‰¹æœåŠ¡
â”‚  â”‚  (å·¥å…·å®¡æ‰¹ã€äººæœºäº¤äº’)           â”‚   â”‚    å®‰å…¨ç½‘å…³
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        Monitor Channel          â”‚â”€â”€â”€â”¼â”€â”€â–º ç›‘æ§ç³»ç»Ÿ
â”‚  â”‚  (é”™è¯¯ã€å®¡è®¡ã€æ€§èƒ½æŒ‡æ ‡)         â”‚   â”‚    æ—¥å¿—å¹³å°
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é€šé“å¯¹æ¯”

| é€šé“ | ç”¨é€” | å…¸å‹è®¢é˜…è€… | äº‹ä»¶é¢‘ç‡ | å…³é”®æ€§ |
|------|------|-----------|---------|--------|
| **Progress** | å®æ—¶è¿›åº¦å±•ç¤º | å‰ç«¯UIã€èŠå¤©ç•Œé¢ | é«˜ï¼ˆæ¯«ç§’çº§ï¼‰ | UIä½“éªŒ |
| **Control** | å®¡æ‰¹å†³ç­– | å®¡æ‰¹æœåŠ¡ã€å®‰å…¨ç½‘å…³ | ä½ï¼ˆæŒ‰éœ€ï¼‰ | å®‰å…¨æ§åˆ¶ |
| **Monitor** | ç›‘æ§å®¡è®¡ | ç›‘æ§ç³»ç»Ÿã€æ—¥å¿—å¹³å° | ä¸­ï¼ˆäº‹ä»¶çº§ï¼‰ | å¯è§‚æµ‹æ€§ |

## ğŸ“¡ Progressé€šé“

Progressé€šé“ç”¨äºå®æ—¶å±•ç¤ºAgentçš„æ‰§è¡Œè¿›åº¦ï¼Œæ˜¯ç”¨æˆ·ç•Œé¢çš„ä¸»è¦æ•°æ®æºã€‚

### äº‹ä»¶ç±»å‹

#### 1. ProgressTextChunkEvent

æµå¼æ–‡æœ¬è¾“å‡ºï¼š

```go
type ProgressTextChunkEvent struct {
    Delta string  // å¢é‡æ–‡æœ¬
}
```

**ä½¿ç”¨åœºæ™¯**ï¼šå®æ—¶æ˜¾ç¤ºAIå›å¤

```go
eventCh := ag.Subscribe([]types.AgentChannel{types.ChannelProgress}, nil)
for envelope := range eventCh {
    if e, ok := envelope.Event.(*types.ProgressTextChunkEvent); ok {
        fmt.Print(e.Delta)  // æµå¼è¾“å‡º
    }
}
```

#### 2. ProgressToolStartEvent

å·¥å…·è°ƒç”¨å¼€å§‹ï¼š

```go
type ProgressToolStartEvent struct {
    Call ToolCall  // å·¥å…·è°ƒç”¨ä¿¡æ¯
}

type ToolCall struct {
    ID    string                 // è°ƒç”¨ID
    Name  string                 // å·¥å…·åç§°
    Input map[string]interface{} // è¾“å…¥å‚æ•°
}
```

**ä½¿ç”¨åœºæ™¯**ï¼šæ˜¾ç¤º"æ­£åœ¨æ‰§è¡ŒXXXå·¥å…·"

```go
case *types.ProgressToolStartEvent:
    fmt.Printf("\n[ğŸ”§ Tool] %s\n", e.Call.Name)
    if desc, ok := toolDescriptions[e.Call.Name]; ok {
        fmt.Printf("  %s\n", desc)
    }
```

#### 3. ProgressToolEndEvent

å·¥å…·è°ƒç”¨ç»“æŸï¼š

```go
type ProgressToolEndEvent struct {
    CallID string                 // è°ƒç”¨ID
    Result map[string]interface{} // æ‰§è¡Œç»“æœ
    Error  error                  // é”™è¯¯ï¼ˆå¦‚æœ‰ï¼‰
}
```

**ä½¿ç”¨åœºæ™¯**ï¼šæ˜¾ç¤ºå·¥å…·æ‰§è¡Œç»“æœ

```go
case *types.ProgressToolEndEvent:
    if e.Error != nil {
        fmt.Printf("  âŒ å¤±è´¥: %v\n", e.Error)
    } else {
        fmt.Printf("  âœ… å®Œæˆ\n")
    }
```

#### 4. ProgressCompleteEvent

å¯¹è¯å®Œæˆï¼š

```go
type ProgressCompleteEvent struct {
    FinalText string   // æœ€ç»ˆæ–‡æœ¬
    StopReason string  // åœæ­¢åŸå› 
}
```

**åœæ­¢åŸå› **ï¼š
- `"end_turn"`: æ­£å¸¸ç»“æŸ
- `"max_tokens"`: è¾¾åˆ°æœ€å¤§tokenæ•°
- `"stop_sequence"`: åŒ¹é…åœæ­¢åºåˆ—
- `"tool_use"`: éœ€è¦å·¥å…·æ‰§è¡Œï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰

### å®Œæ•´è®¢é˜…ç¤ºä¾‹

```go
package main

import (
    "fmt"
    "github.com/wordflowlab/agentsdk/pkg/agent"
    "github.com/wordflowlab/agentsdk/pkg/types"
)

func subscribeProgress(ag *agent.Agent) {
    eventCh := ag.Subscribe([]types.AgentChannel{
        types.ChannelProgress,
    }, nil)

    for envelope := range eventCh {
        switch e := envelope.Event.(type) {
        case *types.ProgressTextChunkEvent:
            // æµå¼è¾“å‡ºæ–‡æœ¬
            fmt.Print(e.Delta)

        case *types.ProgressToolStartEvent:
            // å·¥å…·å¼€å§‹
            fmt.Printf("\n\nğŸ”§ [Tool] %s\n", e.Call.Name)
            fmt.Printf("   Input: %v\n", e.Call.Input)

        case *types.ProgressToolEndEvent:
            // å·¥å…·ç»“æŸ
            if e.Error != nil {
                fmt.Printf("   âŒ Error: %v\n", e.Error)
            } else {
                fmt.Printf("   âœ… Success\n")
            }

        case *types.ProgressCompleteEvent:
            // å¯¹è¯å®Œæˆ
            fmt.Printf("\n\nâœ… å®Œæˆ (Reason: %s)\n", e.StopReason)
        }
    }
}
```

## ğŸ›ï¸ Controlé€šé“

Controlé€šé“ç”¨äºäººæœºäº¤äº’å’Œå®¡æ‰¹æµç¨‹ï¼Œå®ç°å®‰å…¨æ§åˆ¶ã€‚

### äº‹ä»¶ç±»å‹

#### 1. ControlToolApprovalRequest

å·¥å…·å®¡æ‰¹è¯·æ±‚ï¼š

```go
type ControlToolApprovalRequest struct {
    ToolCall ToolCall  // å¾…å®¡æ‰¹çš„å·¥å…·è°ƒç”¨
    Reason   string    // éœ€è¦å®¡æ‰¹çš„åŸå› 
}
```

**ä½¿ç”¨åœºæ™¯**ï¼šæ•æ„Ÿæ“ä½œå®¡æ‰¹

```go
eventCh := ag.Subscribe([]types.AgentChannel{types.ChannelControl}, nil)
for envelope := range eventCh {
    if e, ok := envelope.Event.(*types.ControlToolApprovalRequest); ok {
        // æ˜¾ç¤ºå®¡æ‰¹è¯·æ±‚
        fmt.Printf("âš ï¸  éœ€è¦å®¡æ‰¹: %s\n", e.ToolCall.Name)
        fmt.Printf("   åŸå› : %s\n", e.Reason)

        // è·å–ç”¨æˆ·ç¡®è®¤
        fmt.Print("   æ˜¯å¦å…è®¸? (y/n): ")
        var answer string
        fmt.Scanln(&answer)

        // å“åº”å®¡æ‰¹
        if answer == "y" {
            ag.ApproveToolCall(envelope.ID, true)
        } else {
            ag.ApproveToolCall(envelope.ID, false)
        }
    }
}
```

#### 2. ControlUserInputRequest

è¯·æ±‚ç”¨æˆ·è¾“å…¥ï¼š

```go
type ControlUserInputRequest struct {
    Prompt  string   // æç¤ºä¿¡æ¯
    Options []string // å¯é€‰é¡¹ï¼ˆå¦‚æœ‰ï¼‰
}
```

**ä½¿ç”¨åœºæ™¯**ï¼šéœ€è¦ç”¨æˆ·æä¾›é¢å¤–ä¿¡æ¯

```go
case *types.ControlUserInputRequest:
    fmt.Printf("ğŸ’­ Agentè¯·æ±‚è¾“å…¥: %s\n", e.Prompt)
    if len(e.Options) > 0 {
        for i, opt := range e.Options {
            fmt.Printf("   %d. %s\n", i+1, opt)
        }
    }

    // è·å–è¾“å…¥
    var input string
    fmt.Scanln(&input)

    // å‘é€å“åº”
    ag.RespondToInputRequest(envelope.ID, input)
```

### æƒé™ç­–ç•¥é…ç½®

```go
// é…ç½®å·¥å…·æƒé™
config := &types.AgentConfig{
    ToolPermissions: map[string]types.PermissionPolicy{
        "Write": types.PermissionAsk,    // éœ€è¦å®¡æ‰¹
        "fs_delete": types.PermissionDeny,  // æ‹’ç»
        "Read": types.PermissionAllow,   // å…è®¸
    },
}
```

æƒé™ç­–ç•¥ï¼š
- `PermissionAllow`: è‡ªåŠ¨å…è®¸
- `PermissionAsk`: éœ€è¦å®¡æ‰¹
- `PermissionDeny`: è‡ªåŠ¨æ‹’ç»

## ğŸ“Š Monitoré€šé“

Monitoré€šé“ç”¨äºç›‘æ§ã€å®¡è®¡å’Œæ€§èƒ½åˆ†æã€‚

### äº‹ä»¶ç±»å‹

#### 1. MonitorErrorEvent

é”™è¯¯äº‹ä»¶ï¼š

```go
type MonitorErrorEvent struct {
    Error   error  // é”™è¯¯å¯¹è±¡
    Context string // é”™è¯¯ä¸Šä¸‹æ–‡
    AgentID string // Agent ID
}
```

**ä½¿ç”¨åœºæ™¯**ï¼šé”™è¯¯ç›‘æ§å‘Šè­¦

```go
case *types.MonitorErrorEvent:
    log.Printf("[ERROR] Agent %s: %v (Context: %s)",
        e.AgentID, e.Error, e.Context)

    // å‘é€å‘Šè­¦
    alerting.SendAlert("AgentError", e.Error.Error())
```

#### 2. MonitorToolExecutionEvent

å·¥å…·æ‰§è¡Œå®¡è®¡ï¼š

```go
type MonitorToolExecutionEvent struct {
    ToolName  string        // å·¥å…·åç§°
    Duration  time.Duration // æ‰§è¡Œæ—¶é•¿
    Success   bool          // æ˜¯å¦æˆåŠŸ
    InputSize int           // è¾“å…¥å¤§å°
    OutputSize int          // è¾“å‡ºå¤§å°
}
```

**ä½¿ç”¨åœºæ™¯**ï¼šæ€§èƒ½ç›‘æ§å’Œå®¡è®¡æ—¥å¿—

```go
case *types.MonitorToolExecutionEvent:
    log.Printf("[AUDIT] Tool=%s Duration=%v Success=%v",
        e.ToolName, e.Duration, e.Success)

    // è®°å½•åˆ°å®¡è®¡æ•°æ®åº“
    auditDB.LogToolExecution(e)

    // æ€§èƒ½æŒ‡æ ‡
    metrics.RecordToolDuration(e.ToolName, e.Duration)
```

#### 3. MonitorModelCallEvent

æ¨¡å‹è°ƒç”¨ç›‘æ§ï¼š

```go
type MonitorModelCallEvent struct {
    Model         string        // æ¨¡å‹åç§°
    InputTokens   int           // è¾“å…¥tokenæ•°
    OutputTokens  int           // è¾“å‡ºtokenæ•°
    Duration      time.Duration // è°ƒç”¨æ—¶é•¿
    Cost          float64       // æˆæœ¬ï¼ˆç¾å…ƒï¼‰
}
```

**ä½¿ç”¨åœºæ™¯**ï¼šæˆæœ¬å’Œæ€§èƒ½ç›‘æ§

```go
case *types.MonitorModelCallEvent:
    // è®°å½•tokenä½¿ç”¨
    metrics.RecordTokenUsage(e.Model, e.InputTokens, e.OutputTokens)

    // æˆæœ¬ç»Ÿè®¡
    totalCost += e.Cost
    fmt.Printf("æœ¬æ¬¡è°ƒç”¨æˆæœ¬: $%.4f (ç´¯è®¡: $%.4f)\n", e.Cost, totalCost)

    // æ€§èƒ½ç›‘æ§
    if e.Duration > 30*time.Second {
        log.Printf("[WARN] æ¨¡å‹è°ƒç”¨è€—æ—¶è¿‡é•¿: %v", e.Duration)
    }
```

### å®Œæ•´ç›‘æ§ç¤ºä¾‹

```go
func setupMonitoring(ag *agent.Agent) {
    monitorCh := ag.Subscribe([]types.AgentChannel{
        types.ChannelMonitor,
    }, nil)

    go func() {
        var stats struct {
            TotalCost    float64
            ToolCalls    int
            ToolErrors   int
            AvgDuration  time.Duration
        }

        for envelope := range monitorCh {
            switch e := envelope.Event.(type) {
            case *types.MonitorErrorEvent:
                log.Printf("âŒ Error: %v", e.Error)
                stats.ToolErrors++

            case *types.MonitorToolExecutionEvent:
                stats.ToolCalls++
                stats.AvgDuration = (stats.AvgDuration + e.Duration) / 2

            case *types.MonitorModelCallEvent:
                stats.TotalCost += e.Cost
                log.Printf("ğŸ’° Cost: $%.4f (Total: $%.4f)",
                    e.Cost, stats.TotalCost)
            }
        }
    }()
}
```

## ğŸ”§ è®¢é˜…å’Œè¿‡æ»¤

### å¤šé€šé“è®¢é˜…

```go
// è®¢é˜…å¤šä¸ªé€šé“
eventCh := ag.Subscribe([]types.AgentChannel{
    types.ChannelProgress,
    types.ChannelMonitor,
}, nil)

for envelope := range eventCh {
    // å¤„ç†æ¥è‡ªä¸¤ä¸ªé€šé“çš„äº‹ä»¶
}
```

### äº‹ä»¶è¿‡æ»¤

```go
// åªè®¢é˜…ç‰¹å®šäº‹ä»¶ç±»å‹
eventCh := ag.Subscribe(
    []types.AgentChannel{types.ChannelProgress},
    &types.EventFilter{
        EventTypes: []string{
            "progress.text_chunk",
            "progress.complete",
        },
    },
)
```

### å¤šè®¢é˜…è€…

```go
// è®¢é˜…è€…1ï¼šUIå±•ç¤º
uiCh := ag.Subscribe([]types.AgentChannel{types.ChannelProgress}, nil)
go handleUI(uiCh)

// è®¢é˜…è€…2ï¼šæ—¥å¿—è®°å½•
logCh := ag.Subscribe([]types.AgentChannel{types.ChannelMonitor}, nil)
go handleLogs(logCh)

// è®¢é˜…è€…3ï¼šå®¡æ‰¹å¤„ç†
controlCh := ag.Subscribe([]types.AgentChannel{types.ChannelControl}, nil)
go handleApprovals(controlCh)
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. åˆ†ç¦»å…³æ³¨ç‚¹

```go
// âœ… æ¨èï¼šæ¯ä¸ªé€šé“ä¸€ä¸ªå¤„ç†å™¨
go handleProgress(ag.Subscribe([]types.AgentChannel{types.ChannelProgress}, nil))
go handleControl(ag.Subscribe([]types.AgentChannel{types.ChannelControl}, nil))
go handleMonitor(ag.Subscribe([]types.AgentChannel{types.ChannelMonitor}, nil))

// âŒ ä¸æ¨èï¼šæ··åœ¨ä¸€èµ·å¤„ç†
eventCh := ag.Subscribe(allChannels, nil)
// ä¸€ä¸ªgoroutineå¤„ç†æ‰€æœ‰ç±»å‹çš„äº‹ä»¶
```

### 2. å¼‚æ­¥å¤„ç†

```go
// âœ… æ¨èï¼šå¼‚æ­¥å¤„ç†äº‹ä»¶
go func() {
    for event := range eventCh {
        processEvent(event)
    }
}()

// âŒ ä¸æ¨èï¼šåŒæ­¥é˜»å¡ä¸»çº¿ç¨‹
for event := range eventCh {
    processEvent(event)  // é˜»å¡ä¸»çº¿ç¨‹
}
```

### 3. é”™è¯¯æ¢å¤

```go
go func() {
    defer func() {
        if r := recover(); r != nil {
            log.Printf("äº‹ä»¶å¤„ç†panic: %v", r)
        }
    }()

    for event := range eventCh {
        if err := processEvent(event); err != nil {
            log.Printf("å¤„ç†äº‹ä»¶å¤±è´¥: %v", err)
            continue  // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªäº‹ä»¶
        }
    }
}()
```

### 4. èµ„æºæ¸…ç†

```go
eventCh := ag.Subscribe(channels, nil)
defer func() {
    // å…³é—­è®¢é˜…
    ag.Unsubscribe(eventCh)
}()
```

### 5. èƒŒå‹å¤„ç†

```go
// ä½¿ç”¨å¸¦ç¼“å†²çš„channel
eventCh := ag.Subscribe(channels, &types.SubscribeOptions{
    BufferSize: 100,  // ç¼“å†²100ä¸ªäº‹ä»¶
})

// æˆ–ä½¿ç”¨éé˜»å¡è¯»å–
select {
case event := <-eventCh:
    processEvent(event)
case <-time.After(100 * time.Millisecond):
    // è¶…æ—¶ï¼Œè·³è¿‡
}
```

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### äº‹ä»¶é¢‘ç‡

| äº‹ä»¶ç±»å‹ | å…¸å‹é¢‘ç‡ | å¤„ç†æ—¶é—´è¦æ±‚ |
|---------|---------|------------|
| ProgressTextChunk | 10-50/ç§’ | <10ms |
| ProgressToolStart/End | 1-5/å¯¹è¯ | <100ms |
| MonitorEvent | æŒ‰éœ€ | <50ms |
| ControlEvent | ç½•è§ | äººå·¥å†³ç­– |

### æ€§èƒ½ä¼˜åŒ–

```go
// æ‰¹é‡å¤„ç†æ–‡æœ¬chunk
var buffer strings.Builder
ticker := time.NewTicker(100 * time.Millisecond)

for {
    select {
    case event := <-eventCh:
        if e, ok := event.(*types.ProgressTextChunkEvent); ok {
            buffer.WriteString(e.Delta)
        }
    case <-ticker.C:
        if buffer.Len() > 0 {
            displayText(buffer.String())
            buffer.Reset()
        }
    }
}
```

## ğŸ“š ä¸‹ä¸€æ­¥

- [ä¸­é—´ä»¶ç³»ç»Ÿ](/core-concepts/middleware) - å­¦ä¹ æ´‹è‘±æ¨¡å‹å’Œäº‹ä»¶æ‹¦æˆª
- [Agentç”Ÿå‘½å‘¨æœŸ](/core-concepts/agent-lifecycle) - ç†è§£äº‹ä»¶åœ¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ä½œç”¨
- [å®æˆ˜æŒ‡å—](/guides/event-handling) - å®Œæ•´çš„äº‹ä»¶å¤„ç†ç¤ºä¾‹

## ğŸ”— ç›¸å…³API

- [agent.Subscribe](/api-reference/agent-api#subscribe)
- [agent.Unsubscribe](/api-reference/agent-api#unsubscribe)
- [types.EventFilter](/api-reference/types-api#eventfilter)
- [types.AgentChannel](/api-reference/types-api#agentchannel)
