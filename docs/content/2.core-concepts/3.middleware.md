---
title: ä¸­é—´ä»¶ç³»ç»Ÿ
description: æ·±å…¥ç†è§£æ´‹è‘±æ¨¡å‹ä¸­é—´ä»¶æ¶æ„
---

# ä¸­é—´ä»¶ç³»ç»Ÿ

AgentSDKçš„ä¸­é—´ä»¶ç³»ç»Ÿé‡‡ç”¨æ´‹è‘±æ¨¡å‹ï¼ˆOnion Modelï¼‰æ¶æ„ï¼Œå®ç°äº†é«˜åº¦å¯æ‰©å±•çš„åŠŸèƒ½ç»„åˆæœºåˆ¶ã€‚

## ğŸ§… æ´‹è‘±æ¨¡å‹

![ä¸­é—´ä»¶æ´‹è‘±æ¨¡å‹](/agentsdk/images/middleware-onion.svg)

### æ ¸å¿ƒæ€æƒ³

```
Request â†’ M1 â†’ M2 â†’ M3 â†’ Handler â†’ M3 â†’ M2 â†’ M1 â†’ Response
          â†“    â†“    â†“              â†‘    â†‘    â†‘
      Before Before Before       After After After
```

æ¯ä¸ªè¯·æ±‚å’Œå“åº”éƒ½ä¼šä¾æ¬¡é€šè¿‡å¤šå±‚ä¸­é—´ä»¶ï¼š
- **è¯·æ±‚é˜¶æ®µ**ï¼šä»å¤–åˆ°å†…ï¼ˆä¼˜å…ˆçº§ä»ä½åˆ°é«˜ï¼‰
- **å“åº”é˜¶æ®µ**ï¼šä»å†…åˆ°å¤–ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰

### ä¸ºä»€ä¹ˆæ˜¯æ´‹è‘±æ¨¡å‹ï¼Ÿ

**ä¼˜åŠ¿**ï¼š
1. **æ¸…æ™°çš„å±‚æ¬¡**ï¼šåŠŸèƒ½æŒ‰ä¼˜å…ˆçº§åˆ†å±‚
2. **åŒå‘æ‹¦æˆª**ï¼šå¯ä»¥åœ¨å‰åéƒ½å¤„ç†
3. **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ ä¸­é—´ä»¶ä¸å½±å“ç°æœ‰ä»£ç 
4. **å¯ç»„åˆæ€§**ï¼šä¸­é—´ä»¶å¯ä»¥è‡ªç”±ç»„åˆ

## ğŸ”§ Middlewareæ¥å£

### å®Œæ•´æ¥å£å®šä¹‰

```go
type Middleware interface {
    // åŸºç¡€ä¿¡æ¯
    Name() string       // ä¸­é—´ä»¶åç§°
    Priority() int      // ä¼˜å…ˆçº§ï¼ˆæ•°å€¼è¶Šå°è¶Šé è¿‘æ ¸å¿ƒï¼‰

    // å·¥å…·æä¾›
    Tools() []tools.Tool  // æ­¤ä¸­é—´ä»¶æä¾›çš„å·¥å…·

    // åŒå‘æ‹¦æˆª
    WrapModelCall(ctx context.Context, req *ModelRequest,
                  next ModelCallHandler) (*ModelResponse, error)

    WrapToolCall(ctx context.Context, req *ToolCallRequest,
                 next ToolCallHandler) (*ToolCallResponse, error)

    // ç”Ÿå‘½å‘¨æœŸé’©å­
    OnAgentStart(ctx context.Context, agentID string) error
    OnAgentStop(ctx context.Context, agentID string) error
}
```

### ä¼˜å…ˆçº§è§„èŒƒ

```go
const (
    // 0-100: ç³»ç»Ÿçº§ä¸­é—´ä»¶
    PrioritySystem = 0

    // 100-500: åŠŸèƒ½çº§ä¸­é—´ä»¶
    PrioritySummarization = 40   // æ€»ç»“ä¸­é—´ä»¶
    PriorityFilesystem    = 100  // æ–‡ä»¶ç³»ç»Ÿ
    PrioritySubAgent      = 200  // å­Agent

    // 500-1000: ä¸šåŠ¡çº§ä¸­é—´ä»¶
    PriorityBusiness = 500
    PriorityCustom   = 1000
)
```

**è§„åˆ™**ï¼š
- æ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šé è¿‘æ ¸å¿ƒ
- åœ¨è¯·æ±‚é˜¶æ®µï¼Œä¼˜å…ˆçº§é«˜çš„å…ˆæ‰§è¡Œ
- åœ¨å“åº”é˜¶æ®µï¼Œä¼˜å…ˆçº§é«˜çš„åæ‰§è¡Œ

## ğŸ“¦ å†…ç½®ä¸­é—´ä»¶

### 1. SummarizationMiddleware

**åŠŸèƒ½**ï¼šè‡ªåŠ¨ç®¡ç†ä¸Šä¸‹æ–‡é•¿åº¦

**ä¼˜å…ˆçº§**ï¼š40ï¼ˆéå¸¸æ¥è¿‘æ ¸å¿ƒï¼‰

**å·¥ä½œåŸç†**ï¼š

```go
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç›‘æ§æ¶ˆæ¯å†å² token æ•°               â”‚
â”‚         â”‚                           â”‚
â”‚         â–¼                           â”‚
â”‚  è¶…è¿‡é˜ˆå€¼? (170k tokens)             â”‚
â”‚    No â”€â”  â”‚ Yes                     â”‚
â”‚        â”‚  â–¼                         â”‚
â”‚        â”‚ 1. ä¿ç•™æœ€è¿‘6æ¡æ¶ˆæ¯          â”‚
â”‚        â”‚ 2. æ€»ç»“æ›´æ—©çš„æ¶ˆæ¯           â”‚
â”‚        â”‚ 3. æ›¿æ¢æ—§å†å²               â”‚
â”‚        â”‚  â”‚                         â”‚
â”‚        â””â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®ç¤ºä¾‹**ï¼š

```go
// ä½¿ç”¨é»˜è®¤é…ç½®
config := &types.AgentConfig{
    Middlewares: []string{"summarization"},
}

// è‡ªå®šä¹‰é…ç½®
summaryMiddleware := middleware.NewSummarizationMiddleware(&middleware.SummarizationConfig{
    TokenThreshold:  150000,  // 150k tokensè§¦å‘
    KeepRecentCount: 10,      // ä¿ç•™æœ€è¿‘10æ¡
})
```

**é€‚ç”¨åœºæ™¯**ï¼š
- é•¿æ—¶é—´å¯¹è¯
- éœ€è¦ä¿æŒä¸Šä¸‹æ–‡ä½†åˆæ‹…å¿ƒtokenè¶…é™
- è‡ªåŠ¨ç»´æŠ¤å¯¹è¯å†å²

### 2. FilesystemMiddleware

**åŠŸèƒ½**ï¼šæä¾›æ–‡ä»¶ç³»ç»Ÿæ“ä½œå·¥å…·

**ä¼˜å…ˆçº§**ï¼š100

**æä¾›çš„å·¥å…·**ï¼š
- `fs_read` - è¯»å–æ–‡ä»¶
- `fs_write` - å†™å…¥æ–‡ä»¶
- `fs_edit` - ç¼–è¾‘æ–‡ä»¶
- `fs_ls` - åˆ—å‡ºç›®å½•
- `fs_glob` - GlobåŒ¹é…
- `fs_grep` - æ­£åˆ™æœç´¢

**ç‰¹æ€§**ï¼š

1. **è‡ªåŠ¨ç»“æœé©±é€**

```go
// å½“å·¥å…·ç»“æœè¶…è¿‡20k tokensæ—¶è‡ªåŠ¨é©±é€
config := &middleware.FilesystemMiddlewareConfig{
    Backend:        backend,
    EnableEviction: true,
    TokenLimit:     20000,
}
```

2. **BackendæŠ½è±¡**

```go
// æ”¯æŒå¤šç§å­˜å‚¨åç«¯
fsMiddleware := middleware.NewFilesystemMiddleware(&middleware.FilesystemMiddlewareConfig{
    Backend: backends.NewCompositeBackend(
        backends.NewStateBackend(),
        []backends.RouteConfig{
            {Prefix: "/workspace/", Backend: realFS},
        },
    ),
})
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
// å¯ç”¨æ–‡ä»¶ç³»ç»Ÿä¸­é—´ä»¶
config := &types.AgentConfig{
    Middlewares: []string{"filesystem"},
}

// Agentç°åœ¨å¯ä»¥ä½¿ç”¨fs_*å·¥å…·
ag.Chat(ctx, "è¯»å–README.mdæ–‡ä»¶")
```

### 3. AgentMemoryMiddleware

**åŠŸèƒ½**ï¼šåŸºäºæ™®é€šæ–‡ä»¶+æœç´¢çš„é•¿æœŸè®°å¿†ä¸­é—´ä»¶ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- ä»åç«¯è¯»å– `/agent.md`ï¼Œå°†å…¶ä½œä¸º `<agent_memory>...</agent_memory>` æ³¨å…¥ System Promptï¼Œæä¾›â€œäººæ ¼/é•¿æœŸæŒ‡ä»¤â€ã€‚
- åŸºäº `backends.BackendProtocol` åœ¨æŒ‡å®š `MemoryPath` ä¸‹ç®¡ç†è®°å¿†æ–‡ä»¶ï¼ˆé»˜è®¤ä¸º `/memories/`ï¼‰ã€‚
- è‡ªåŠ¨æ³¨å…¥ `memory_search` / `memory_write` å·¥å…·ï¼Œé…åˆ `fs_*` å·¥å…·æ„æˆçº¯æ–‡æœ¬çš„é•¿æœŸè®°å¿†ç³»ç»Ÿã€‚

**å…¸å‹ç”¨æ³•**ï¼š

```go
// Backend ç¤ºä¾‹: /memories/ æ˜ å°„åˆ°æœ¬åœ°ç›®å½•
memoryBackend := backends.NewCompositeBackend(
    backends.NewStateBackend(),
    []backends.RouteConfig{
        {
            Prefix:  "/memories/",
            Backend: backends.NewLocalBackend("./memories"),
        },
    },
)

memoryMW, _ := middleware.NewAgentMemoryMiddleware(&middleware.AgentMemoryMiddlewareConfig{
    Backend:    memoryBackend,
    MemoryPath: "/memories/",
})
```

> æç¤ºï¼šåœ¨å®é™… AgentConfig ä¸­ï¼Œé€šå¸¸ä¼šåŒæ—¶å¯ç”¨ `filesystem` ä¸­é—´ä»¶ï¼Œè®© Agent æ—¢èƒ½æ“ä½œé¡¹ç›®æ–‡ä»¶ï¼Œåˆèƒ½ç›´æ¥æŸ¥çœ‹ `/memories/` ä¸­çš„è®°å¿†æ–‡ä»¶ã€‚

### 4. SubAgentMiddleware

**åŠŸèƒ½**ï¼šä»»åŠ¡å§”æ´¾åˆ°å­Agent

**ä¼˜å…ˆçº§**ï¼š200

**æä¾›çš„å·¥å…·**ï¼š
- `task` - å§”æ´¾ä»»åŠ¡åˆ°å­Agent

**å·¥ä½œæµç¨‹**ï¼š

```
Main Agent
    â”‚
    â–¼ task("researcher", "ç ”ç©¶Goæ€§èƒ½ä¼˜åŒ–")
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SubAgentMiddleware â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ åˆ›å»ºå­Agent
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Researcher Agent   â”‚  ç‹¬ç«‹ä¸Šä¸‹æ–‡
â”‚  (éš”ç¦»æ‰§è¡Œ)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ è¿”å›ç»“æœ
Main Agentç»§ç»­
```

**é…ç½®ç¤ºä¾‹**ï¼š

```go
// å®šä¹‰å­Agentè§„æ ¼
specs := []middleware.SubAgentSpec{
    {
        Name:        "researcher",
        Description: "æ·±åº¦ç ”ç©¶å’Œåˆ†æä¸“å®¶",
        Prompt:      "ä½ æ˜¯ä¸€ä¸ªç ”ç©¶ä¸“å®¶ï¼Œæä¾›è¯¦ç»†çš„åˆ†æã€‚",
    },
    {
        Name:        "coder",
        Description: "ä»£ç ç¼–å†™ä¸“å®¶",
        Prompt:      "ä½ æ˜¯ä¸“ä¸šç¨‹åºå‘˜ï¼Œç¼–å†™æ¸…æ™°çš„ä»£ç ã€‚",
    },
}

// åˆ›å»ºå·¥å‚å‡½æ•°
factory := func(ctx context.Context, spec middleware.SubAgentSpec) (middleware.SubAgent, error) {
    // åˆ›å»ºå®é™…çš„Agentå®ä¾‹
    return agent.Create(ctx, &types.AgentConfig{
        SystemPrompt: spec.Prompt,
        Model:        "claude-sonnet-4-5",
    }, deps)
}

// åˆ›å»ºä¸­é—´ä»¶
subagentMiddleware := middleware.NewSubAgentMiddleware(&middleware.SubAgentMiddlewareConfig{
    Specs:          specs,
    Factory:        factory,
    EnableParallel: true,  // å…è®¸å¹¶å‘æ‰§è¡Œ
})
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
// Main Agentå§”æ´¾ä»»åŠ¡
ag.Chat(ctx, `
ä½¿ç”¨researcherå­Agentç ”ç©¶"Goå¹¶å‘æ¨¡å‹çš„ä¼˜åŠ¿"ï¼Œ
ç„¶ååŸºäºç ”ç©¶ç»“æœç¼–å†™ä»£ç ç¤ºä¾‹ã€‚
`)
```

## ğŸ—ï¸ åˆ›å»ºè‡ªå®šä¹‰ä¸­é—´ä»¶

### åŸºç¡€ä¸­é—´ä»¶

```go
package mymiddleware

import (
    "context"
    "github.com/wordflowlab/agentsdk/pkg/middleware"
    "github.com/wordflowlab/agentsdk/pkg/tools"
)

type LoggingMiddleware struct {
    *middleware.BaseMiddleware
}

func NewLoggingMiddleware() *LoggingMiddleware {
    return &LoggingMiddleware{
        BaseMiddleware: middleware.NewBaseMiddleware(
            "logging",  // åç§°
            300,        // ä¼˜å…ˆçº§
        ),
    }
}

// æä¾›å·¥å…·ï¼ˆå¯é€‰ï¼‰
func (m *LoggingMiddleware) Tools() []tools.Tool {
    return nil  // ä¸æä¾›å·¥å…·
}

// æ‹¦æˆªæ¨¡å‹è°ƒç”¨
func (m *LoggingMiddleware) WrapModelCall(
    ctx context.Context,
    req *types.ModelRequest,
    next middleware.ModelCallHandler,
) (*types.ModelResponse, error) {
    // å‰ç½®å¤„ç†
    log.Printf("[Before ModelCall] Messages: %d", len(req.Messages))
    start := time.Now()

    // è°ƒç”¨ä¸‹ä¸€å±‚
    resp, err := next(ctx, req)

    // åç½®å¤„ç†
    duration := time.Since(start)
    log.Printf("[After ModelCall] Duration: %v, Error: %v", duration, err)

    return resp, err
}

// æ‹¦æˆªå·¥å…·è°ƒç”¨
func (m *LoggingMiddleware) WrapToolCall(
    ctx context.Context,
    req *types.ToolCallRequest,
    next middleware.ToolCallHandler,
) (*types.ToolCallResponse, error) {
    // å‰ç½®å¤„ç†
    log.Printf("[Before ToolCall] Tool: %s, Input: %v",
        req.ToolName, req.Input)

    // è°ƒç”¨ä¸‹ä¸€å±‚
    resp, err := next(ctx, req)

    // åç½®å¤„ç†
    log.Printf("[After ToolCall] Tool: %s, Success: %v",
        req.ToolName, err == nil)

    return resp, err
}

// ç”Ÿå‘½å‘¨æœŸé’©å­
func (m *LoggingMiddleware) OnAgentStart(ctx context.Context, agentID string) error {
    log.Printf("[Agent Start] %s", agentID)
    return nil
}

func (m *LoggingMiddleware) OnAgentStop(ctx context.Context, agentID string) error {
    log.Printf("[Agent Stop] %s", agentID)
    return nil
}
```

### å¸¦å·¥å…·çš„ä¸­é—´ä»¶

```go
type CachingMiddleware struct {
    *middleware.BaseMiddleware
    cache map[string]interface{}
}

func NewCachingMiddleware() *CachingMiddleware {
    return &CachingMiddleware{
        BaseMiddleware: middleware.NewBaseMiddleware("caching", 250),
        cache:          make(map[string]interface{}),
    }
}

// æä¾›ç¼“å­˜å·¥å…·
func (m *CachingMiddleware) Tools() []tools.Tool {
    return []tools.Tool{
        &CacheGetTool{cache: m.cache},
        &CacheSetTool{cache: m.cache},
        &CacheClearTool{cache: m.cache},
    }
}

// å®ç°å·¥å…·
type CacheGetTool struct {
    cache map[string]interface{}
}

func (t *CacheGetTool) Name() string { return "cache_get" }

func (t *CacheGetTool) Description() string {
    return "ä»ç¼“å­˜ä¸­è·å–å€¼"
}

func (t *CacheGetTool) InputSchema() map[string]interface{} {
    return map[string]interface{}{
        "type": "object",
        "properties": map[string]interface{}{
            "key": map[string]string{"type": "string"},
        },
        "required": []string{"key"},
    }
}

func (t *CacheGetTool) Execute(ctx context.Context, input map[string]interface{}) (interface{}, error) {
    key := input["key"].(string)
    if value, ok := t.cache[key]; ok {
        return map[string]interface{}{
            "ok":    true,
            "value": value,
        }, nil
    }
    return map[string]interface{}{
        "ok":    false,
        "error": "key not found",
    }, nil
}
```

## ğŸ“š ä¸­é—´ä»¶æ ˆç®¡ç†

### åˆ›å»ºæ ˆ

```go
// åˆ›å»ºä¸­é—´ä»¶å®ä¾‹
fsMiddleware := middleware.NewFilesystemMiddleware(fsConfig)
subagentMiddleware := middleware.NewSubAgentMiddleware(subagentConfig)
loggingMiddleware := NewLoggingMiddleware()

// åˆ›å»ºæ ˆï¼ˆè‡ªåŠ¨æŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
stack := middleware.NewStack([]middleware.Middleware{
    loggingMiddleware,    // priority: 300
    fsMiddleware,         // priority: 100
    subagentMiddleware,   // priority: 200
})

// å®é™…é¡ºåºï¼šfs(100) â†’ subagent(200) â†’ logging(300)
```

### è·å–å·¥å…·

```go
// æ”¶é›†æ‰€æœ‰ä¸­é—´ä»¶æä¾›çš„å·¥å…·
tools := stack.Tools()
fmt.Printf("å¯ç”¨å·¥å…·: %dä¸ª\n", len(tools))

for _, tool := range tools {
    fmt.Printf("- %s: %s\n", tool.Name(), tool.Description())
}
```

### æ‰§è¡Œè°ƒç”¨

```go
// æ¨¡å‹è°ƒç”¨ç»è¿‡æ•´ä¸ªæ ˆ
response, err := stack.WrapModelCall(ctx, request, func(ctx context.Context, req *types.ModelRequest) (*types.ModelResponse, error) {
    // æœ€ç»ˆçš„å¤„ç†å‡½æ•°
    return provider.StreamMessages(ctx, req)
})

// å·¥å…·è°ƒç”¨ç»è¿‡æ•´ä¸ªæ ˆ
toolResponse, err := stack.WrapToolCall(ctx, toolRequest, func(ctx context.Context, req *types.ToolCallRequest) (*types.ToolCallResponse, error) {
    // æœ€ç»ˆçš„å·¥å…·æ‰§è¡Œ
    return executor.Execute(ctx, req)
})
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ€§èƒ½ç›‘æ§ä¸­é—´ä»¶

```go
type MetricsMiddleware struct {
    *middleware.BaseMiddleware
    metrics *prometheus.Registry
}

func (m *MetricsMiddleware) WrapModelCall(ctx, req, next) (*types.ModelResponse, error) {
    start := time.Now()
    resp, err := next(ctx, req)

    // è®°å½•æŒ‡æ ‡
    m.metrics.RecordLatency("model_call", time.Since(start))
    m.metrics.IncrementCounter("model_calls_total")
    if err != nil {
        m.metrics.IncrementCounter("model_calls_errors")
    }

    return resp, err
}
```

### åœºæ™¯2ï¼šå®‰å…¨å®¡è®¡ä¸­é—´ä»¶

```go
type AuditMiddleware struct {
    *middleware.BaseMiddleware
    auditLog AuditLogger
}

func (m *AuditMiddleware) WrapToolCall(ctx, req, next) (*types.ToolCallResponse, error) {
    // è®°å½•å®¡è®¡æ—¥å¿—
    m.auditLog.Log(&AuditEntry{
        Timestamp: time.Now(),
        AgentID:   req.AgentID,
        ToolName:  req.ToolName,
        Input:     req.Input,
    })

    resp, err := next(ctx, req)

    // è®°å½•ç»“æœ
    m.auditLog.Log(&AuditEntry{
        Type:    "tool_result",
        Success: err == nil,
        Output:  resp.Result,
    })

    return resp, err
}
```

### åœºæ™¯3ï¼šé‡è¯•ä¸­é—´ä»¶

```go
type RetryMiddleware struct {
    *middleware.BaseMiddleware
    maxRetries int
}

func (m *RetryMiddleware) WrapModelCall(ctx, req, next) (*types.ModelResponse, error) {
    var resp *types.ModelResponse
    var err error

    for i := 0; i < m.maxRetries; i++ {
        resp, err = next(ctx, req)
        if err == nil {
            return resp, nil
        }

        // æŒ‡æ•°é€€é¿
        time.Sleep(time.Duration(1<<uint(i)) * time.Second)
    }

    return nil, fmt.Errorf("failed after %d retries: %w", m.maxRetries, err)
}
```

### åœºæ™¯4ï¼šè¯·æ±‚è½¬æ¢ä¸­é—´ä»¶

```go
type TransformMiddleware struct {
    *middleware.BaseMiddleware
}

func (m *TransformMiddleware) WrapModelCall(ctx, req, next) (*types.ModelResponse, error) {
    // è¯·æ±‚è½¬æ¢
    newReq := m.transformRequest(req)

    // è°ƒç”¨ä¸‹ä¸€å±‚
    resp, err := next(ctx, newReq)

    // å“åº”è½¬æ¢
    return m.transformResponse(resp), err
}

func (m *TransformMiddleware) transformRequest(req *types.ModelRequest) *types.ModelRequest {
    // ä¾‹å¦‚ï¼šæ·»åŠ é¢å¤–çš„ç³»ç»Ÿæ¶ˆæ¯
    newMessages := append([]types.Message{
        {Role: "system", Content: "é¢å¤–çš„æŒ‡ä»¤"},
    }, req.Messages...)

    return &types.ModelRequest{
        Messages: newMessages,
        Model:    req.Model,
    }
}
```

## ğŸ¨ é«˜çº§æ¨¡å¼

### 1. ä¸­é—´ä»¶ç»„åˆ

```go
// ç»„åˆå¤šä¸ªä¸­é—´ä»¶å®ç°å¤æ‚åŠŸèƒ½
type CompositeMiddleware struct {
    middlewares []middleware.Middleware
}

func (c *CompositeMiddleware) WrapModelCall(ctx, req, next) (*types.ModelResponse, error) {
    // é“¾å¼è°ƒç”¨
    handler := next
    for i := len(c.middlewares) - 1; i >= 0; i-- {
        m := c.middlewares[i]
        prevHandler := handler
        handler = func(ctx context.Context, r *types.ModelRequest) (*types.ModelResponse, error) {
            return m.WrapModelCall(ctx, r, prevHandler)
        }
    }
    return handler(ctx, req)
}
```

### 2. æ¡ä»¶ä¸­é—´ä»¶

```go
type ConditionalMiddleware struct {
    *middleware.BaseMiddleware
    condition func(*types.ModelRequest) bool
    wrapped   middleware.Middleware
}

func (c *ConditionalMiddleware) WrapModelCall(ctx, req, next) (*types.ModelResponse, error) {
    if c.condition(req) {
        // æ¡ä»¶æ»¡è¶³ï¼Œä½¿ç”¨wrappedä¸­é—´ä»¶
        return c.wrapped.WrapModelCall(ctx, req, next)
    }
    // å¦åˆ™ç›´æ¥pass through
    return next(ctx, req)
}
```

### 3. çŠ¶æ€å…±äº«ä¸­é—´ä»¶

```go
type StatefulMiddleware struct {
    *middleware.BaseMiddleware
    state sync.Map  // çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€å­˜å‚¨
}

func (s *StatefulMiddleware) WrapModelCall(ctx, req, next) (*types.ModelResponse, error) {
    // è¯»å–çŠ¶æ€
    callCount, _ := s.state.LoadOrStore("call_count", 0)

    // æ›´æ–°çŠ¶æ€
    s.state.Store("call_count", callCount.(int)+1)

    return next(ctx, req)
}
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å•ä¸€èŒè´£

```go
// âœ… æ¨èï¼šæ¯ä¸ªä¸­é—´ä»¶åªåšä¸€ä»¶äº‹
type LoggingMiddleware struct { ... }    // åªè´Ÿè´£æ—¥å¿—
type MetricsMiddleware struct { ... }    // åªè´Ÿè´£æŒ‡æ ‡
type CachingMiddleware struct { ... }    // åªè´Ÿè´£ç¼“å­˜

// âŒ ä¸æ¨èï¼šä¸€ä¸ªä¸­é—´ä»¶åšå¤ªå¤šäº‹
type EverythingMiddleware struct { ... }  // æ—¥å¿—+æŒ‡æ ‡+ç¼“å­˜+...
```

### 2. åˆç†è®¾ç½®ä¼˜å…ˆçº§

```go
// æŒ‰ç…§åŠŸèƒ½ç‰¹æ€§è®¾ç½®ä¼˜å…ˆçº§
SummarizationMiddleware  // 40  - å½±å“æ¶ˆæ¯å†å²
FilesystemMiddleware     // 100 - æä¾›åŸºç¡€å·¥å…·
SubAgentMiddleware       // 200 - ä¾èµ–åŸºç¡€å·¥å…·
LoggingMiddleware        // 300 - å¤–å±‚ç›‘æ§
AuthMiddleware           // 10  - æœ€ä¼˜å…ˆï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰
```

### 3. é”™è¯¯å¤„ç†

```go
func (m *MyMiddleware) WrapModelCall(ctx, req, next) (*types.ModelResponse, error) {
    defer func() {
        if r := recover(); r != nil {
            log.Printf("ä¸­é—´ä»¶panic: %v", r)
        }
    }()

    resp, err := next(ctx, req)
    if err != nil {
        // å†³å®šæ˜¯å¦ä¼ æ’­é”™è¯¯
        log.Printf("ä¸‹æ¸¸é”™è¯¯: %v", err)
        return nil, err  // æˆ–è€…å°è¯•æ¢å¤
    }

    return resp, nil
}
```

### 4. æ€§èƒ½è€ƒè™‘

```go
// âœ… æ¨èï¼šå¿«é€Ÿè·¯å¾„
func (m *MyMiddleware) WrapModelCall(ctx, req, next) (*types.ModelResponse, error) {
    if !m.enabled {
        return next(ctx, req)  // å¿«é€Ÿè·³è¿‡
    }

    // å®é™…å¤„ç†
    return m.process(ctx, req, next)
}

// âŒ ä¸æ¨èï¼šæ€»æ˜¯æ‰§è¡Œæ˜‚è´µæ“ä½œ
func (m *MyMiddleware) WrapModelCall(ctx, req, next) (*types.ModelResponse, error) {
    m.expensiveOperation()  // å³ä½¿ä¸éœ€è¦ä¹Ÿæ‰§è¡Œ
    return next(ctx, req)
}
```

## ğŸ“š ä¸‹ä¸€æ­¥

- [å·¥å…·ç³»ç»Ÿ](/core-concepts/tools-system) - åˆ›å»ºè‡ªå®šä¹‰å·¥å…·
- [Agentç”Ÿå‘½å‘¨æœŸ](/core-concepts/agent-lifecycle) - ç†è§£ä¸­é—´ä»¶é’©å­æ—¶æœº
- [å®æˆ˜æŒ‡å—](/guides/custom-middleware) - å®Œæ•´ä¸­é—´ä»¶å¼€å‘ç¤ºä¾‹
- [APIå‚è€ƒ](/api-reference/middleware-api) - è¯¦ç»†APIæ–‡æ¡£

## ğŸ”— ç›¸å…³èµ„æº

- [Phase 6Cæ–‡æ¡£](https://github.com/wordflowlab/agentsdk/blob/main/docs/PHASE6C_MIDDLEWARE_INTEGRATION.md)
- [ä¸­é—´ä»¶ç¤ºä¾‹](https://github.com/wordflowlab/agentsdk/tree/main/examples/middleware)
- [æ¶æ„è®¾è®¡](/introduction/architecture#middleware-system)
