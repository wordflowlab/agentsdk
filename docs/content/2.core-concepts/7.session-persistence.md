---
title: Session æŒä¹…åŒ–
description: ä½¿ç”¨ PostgreSQL å’Œ MySQL æŒä¹…åŒ– Agent ä¼šè¯å’Œäº‹ä»¶å†å²
---

# Session æŒä¹…åŒ–

Session æŒä¹…åŒ–æ˜¯ AgentSDK Phase 7 å¼•å…¥çš„å…³é”®åŠŸèƒ½ï¼Œæä¾›äº†å®Œæ•´çš„ä¼šè¯çŠ¶æ€å’Œäº‹ä»¶å†å²æŒä¹…åŒ–èƒ½åŠ›ï¼Œæ”¯æŒ PostgreSQL å’Œ MySQL 8.0+ã€‚

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ Session æŒä¹…åŒ–ï¼Ÿ

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒAgent çš„ä¼šè¯å’Œå†å²è®°å½•éœ€è¦æŒä¹…åŒ–å­˜å‚¨ï¼š

- âœ… **ä¼šè¯æ¢å¤**: åº”ç”¨é‡å¯åèƒ½å¤Ÿæ¢å¤ç”¨æˆ·ä¼šè¯
- âœ… **å†å²æŸ¥è¯¢**: æŸ¥çœ‹å®Œæ•´çš„å¯¹è¯å†å²å’Œå·¥å…·è°ƒç”¨è®°å½•
- âœ… **å®¡è®¡åˆè§„**: æ»¡è¶³å®‰å…¨å®¡è®¡å’Œåˆè§„è¦æ±‚
- âœ… **æ•°æ®åˆ†æ**: åˆ†æç”¨æˆ·è¡Œä¸ºå’Œ Agent æ€§èƒ½
- âœ… **è°ƒè¯•ä¼˜åŒ–**: è¿½è¸ªé—®é¢˜å’Œä¼˜åŒ– Agent è¡¨ç°

## ğŸ“Š æ¶æ„è®¾è®¡

```mermaid
graph TB
    Agent[Agent] -->|åˆ›å»ºä¼šè¯| SessionService[Session Service]
    Agent -->|è¿½åŠ äº‹ä»¶| SessionService
    Agent -->|æŸ¥è¯¢å†å²| SessionService

    SessionService --> Interface{Session Interface}

    Interface -->|å¼€å‘/æµ‹è¯•| Memory[Memory Store<br/>å†…å­˜å­˜å‚¨]
    Interface -->|ç”Ÿäº§ç¯å¢ƒ| PostgreSQL[PostgreSQL<br/>JSONBæ”¯æŒ]
    Interface -->|ç”Ÿäº§ç¯å¢ƒ| MySQL[MySQL 8.0+<br/>JSONæ”¯æŒ]

    PostgreSQL --> PGTables[(sessions<br/>session_events)]
    MySQL --> MySQLTables[(sessions<br/>session_events)]

    style SessionService fill:#3b82f6
    style PostgreSQL fill:#10b981
    style MySQL fill:#f59e0b
```

### ä¸‰ç§å­˜å‚¨å®ç°

| å­˜å‚¨ç±»å‹ | ç”¨é€” | æ•°æ®æŒä¹…åŒ– | JSON æ”¯æŒ | é€‚ç”¨åœºæ™¯ |
|---------|------|-----------|-----------|---------|
| **Memory** | å¼€å‘/æµ‹è¯• | âŒ æ—  | âœ… åŸç”Ÿ | æœ¬åœ°å¼€å‘ã€å•å…ƒæµ‹è¯• |
| **PostgreSQL** | ç”Ÿäº§æ¨è | âœ… æŒä¹…åŒ– | âœ… JSONB | å¤æ‚æŸ¥è¯¢ã€å…¨æ–‡æœç´¢ |
| **MySQL 8.0+** | ç”Ÿäº§å¯é€‰ | âœ… æŒä¹…åŒ– | âœ… JSON | å·²æœ‰ MySQL åŸºç¡€è®¾æ–½ |

## ğŸ“ æ•°æ®æ¨¡å‹

### Session è¡¨

å­˜å‚¨ä¼šè¯å…ƒæ•°æ®ï¼š

```mermaid
erDiagram
    SESSION {
        string id PK "ä¼šè¯ID"
        string app_name "åº”ç”¨åç§°"
        string user_id "ç”¨æˆ·ID"
        string agent_id "AgentID"
        string status "çŠ¶æ€(active/completed/failed)"
        jsonb metadata "å…ƒæ•°æ®(JSONB/JSON)"
        timestamp created_at "åˆ›å»ºæ—¶é—´"
        timestamp updated_at "æ›´æ–°æ—¶é—´"
    }

    SESSION ||--o{ EVENT : has

    EVENT {
        string id PK "äº‹ä»¶ID"
        string session_id FK "ä¼šè¯ID"
        string invocation_id "è°ƒç”¨ID"
        string agent_id "AgentID"
        string author "ä½œè€…(user/agent)"
        jsonb content "æ¶ˆæ¯å†…å®¹(JSONB/JSON)"
        jsonb actions "äº‹ä»¶åŠ¨ä½œ(JSONB/JSON)"
        jsonb metadata "å…ƒæ•°æ®(JSONB/JSON)"
        string branch "å·¥ä½œæµåˆ†æ”¯"
        timestamp timestamp "æ—¶é—´æˆ³"
    }
```

**Session å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `id` | string | ä¼šè¯å”¯ä¸€ID | `"sess-20250113-abc123"` |
| `app_name` | string | åº”ç”¨åç§° | `"my-chatbot"` |
| `user_id` | string | ç”¨æˆ·ID | `"user-001"` |
| `agent_id` | string | Agent ID | `"agent-assistant"` |
| `status` | string | ä¼šè¯çŠ¶æ€ | `"active"`, `"completed"`, `"failed"` |
| `metadata` | jsonb/json | è‡ªå®šä¹‰å…ƒæ•°æ® | `{"version": "1.0", "env": "prod"}` |

**Event å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `id` | string | äº‹ä»¶å”¯ä¸€ID | `"evt-001"` |
| `session_id` | string | æ‰€å±ä¼šè¯ID | `"sess-20250113-abc123"` |
| `invocation_id` | string | è°ƒç”¨IDï¼ˆå·¥ä½œæµè¿½è¸ªï¼‰ | `"inv-001"` |
| `agent_id` | string | äº§ç”Ÿäº‹ä»¶çš„ Agent ID | `"agent-001"` |
| `author` | string | äº‹ä»¶ä½œè€… | `"user"`, `"agent"` |
| `content` | jsonb/json | æ¶ˆæ¯å†…å®¹ | `{"role": "user", "content": "Hello"}` |
| `actions` | jsonb/json | äº‹ä»¶åŠ¨ä½œ | `{"escalate": false}` |
| `metadata` | jsonb/json | äº‹ä»¶å…ƒæ•°æ® | `{"loop_iteration": 1}` |
| `branch` | string | å·¥ä½œæµåˆ†æ”¯è·¯å¾„ | `"Pipeline.Analyzer"` |

### ç´¢å¼•ä¼˜åŒ–

ä¸ºé«˜æ€§èƒ½æŸ¥è¯¢åˆ›å»ºçš„ç´¢å¼•ï¼š

```sql
-- Session è¡¨ç´¢å¼•
CREATE INDEX idx_sessions_user_id ON sessions(user_id);
CREATE INDEX idx_sessions_agent_id ON sessions(agent_id);
CREATE INDEX idx_sessions_status ON sessions(status);
CREATE INDEX idx_sessions_created_at ON sessions(created_at);

-- Event è¡¨ç´¢å¼•
CREATE INDEX idx_events_session_id ON session_events(session_id);
CREATE INDEX idx_events_timestamp ON session_events(timestamp);
CREATE INDEX idx_events_invocation_id ON session_events(invocation_id);
CREATE INDEX idx_events_agent_id ON session_events(agent_id);
```

## ğŸ”„ ç”Ÿå‘½å‘¨æœŸ

### Session çŠ¶æ€æœº

```mermaid
graph LR
    Active[active<br/>æ´»è·ƒ] -->|æ­£å¸¸å®Œæˆ| Completed[completed<br/>å·²å®Œæˆ]
    Active -->|å‘ç”Ÿé”™è¯¯| Failed[failed<br/>å¤±è´¥]
    Active -->|è¶…æ—¶| Failed

    Completed -->|é‡æ–°æ¿€æ´»| Active
    Failed -->|é‡è¯•| Active

    style Active fill:#3b82f6
    style Completed fill:#10b981
    style Failed fill:#ef4444
```

### å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant App as åº”ç”¨
    participant Agent
    participant SessionService
    participant DB as æ•°æ®åº“

    App->>SessionService: Create(req)
    SessionService->>DB: INSERT INTO sessions
    DB->>SessionService: session_id
    SessionService->>App: Sessionå¯¹è±¡

    loop Agent æ‰§è¡Œ
        App->>Agent: Chat(ctx, message)
        Agent->>SessionService: AppendEvent(event)
        SessionService->>DB: INSERT INTO session_events
        Agent->>App: æµå¼å“åº”
    end

    App->>SessionService: Update(session)
    SessionService->>DB: UPDATE sessions SET status
    SessionService->>App: æ›´æ–°æˆåŠŸ

    App->>SessionService: GetEvents(session_id, filter)
    SessionService->>DB: SELECT * FROM session_events WHERE...
    DB->>SessionService: events[]
    SessionService->>App: äº‹ä»¶åˆ—è¡¨
```

## ğŸ”§ æœåŠ¡æ¥å£

### æ ¸å¿ƒæ¥å£

```go
type SessionService interface {
    // Session ç®¡ç†
    Create(ctx context.Context, req *CreateRequest) (*Session, error)
    Get(ctx context.Context, id string) (*Session, error)
    Update(ctx context.Context, session *Session) error
    Delete(ctx context.Context, id string) error
    List(ctx context.Context, filter *ListFilter) ([]*Session, error)

    // Event ç®¡ç†
    AppendEvent(ctx context.Context, sessionID string, event *Event) error
    AppendEvents(ctx context.Context, sessionID string, events []*Event) error
    GetEvents(ctx context.Context, sessionID string, filter *EventFilter) ([]*Event, error)

    // æ‰¹é‡æ“ä½œ
    DeleteByUser(ctx context.Context, userID string) error
    DeleteByApp(ctx context.Context, appName string) error

    // èµ„æºæ¸…ç†
    Close() error
}
```

### è¿‡æ»¤å™¨

**ListFilter** - Session åˆ—è¡¨æŸ¥è¯¢ï¼š

```go
type ListFilter struct {
    AppName   string    // æŒ‰åº”ç”¨åç§°è¿‡æ»¤
    UserID    string    // æŒ‰ç”¨æˆ·IDè¿‡æ»¤
    AgentID   string    // æŒ‰AgentIDè¿‡æ»¤
    Status    string    // æŒ‰çŠ¶æ€è¿‡æ»¤
    StartTime time.Time // æ—¶é—´èŒƒå›´å¼€å§‹
    EndTime   time.Time // æ—¶é—´èŒƒå›´ç»“æŸ
    Limit     int       // è¿”å›æ•°é‡é™åˆ¶
    Offset    int       // åç§»é‡ï¼ˆåˆ†é¡µï¼‰
}
```

**EventFilter** - Event æŸ¥è¯¢ï¼š

```go
type EventFilter struct {
    InvocationID string    // æŒ‰è°ƒç”¨IDè¿‡æ»¤
    AgentID      string    // æŒ‰AgentIDè¿‡æ»¤
    Author       string    // æŒ‰ä½œè€…è¿‡æ»¤
    StartTime    time.Time // æ—¶é—´èŒƒå›´å¼€å§‹
    EndTime      time.Time // æ—¶é—´èŒƒå›´ç»“æŸ
    Limit        int       // è¿”å›æ•°é‡é™åˆ¶
    Offset       int       // åç§»é‡ï¼ˆåˆ†é¡µï¼‰
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡æ“ä½œ

```go
// âœ… æ¨èï¼šæ‰¹é‡æ’å…¥äº‹ä»¶
events := []*session.Event{ /* ... */ }
service.AppendEvents(ctx, sess.ID, events)  // å•ä¸ªäº‹åŠ¡

// âŒ é¿å…ï¼šé€æ¡æ’å…¥
for _, event := range events {
    service.AppendEvent(ctx, sess.ID, event)  // å¤šä¸ªäº‹åŠ¡ï¼Œæ…¢
}
```

**æ€§èƒ½å¯¹æ¯”**:
- æ‰¹é‡æ’å…¥ï¼š~10msï¼ˆ100æ¡äº‹ä»¶ï¼‰
- é€æ¡æ’å…¥ï¼š~1000msï¼ˆ100æ¡äº‹ä»¶ï¼Œæ¯æ¡10msï¼‰

### 2. è¿æ¥æ± è°ƒä¼˜

```go
// ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
config := &postgres.Config{
    MaxOpenConns: 50,              // æœ€å¤§è¿æ¥æ•°
    MaxIdleConns: 10,              // æœ€å¤§ç©ºé—²è¿æ¥
    MaxLifetime:  5 * time.Minute, // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
}
```

### 3. æŸ¥è¯¢ä¼˜åŒ–

```go
// âœ… æ¨èï¼šä½¿ç”¨ç´¢å¼•å­—æ®µæŸ¥è¯¢
filter := &session.ListFilter{
    UserID:    "user-001",  // æœ‰ç´¢å¼•
    StartTime: yesterday,   // æœ‰ç´¢å¼•
    Limit:     100,
}

// âŒ é¿å…ï¼šLIKE æŸ¥è¯¢æˆ–å…¨è¡¨æ‰«æ
// ä½¿ç”¨ metadata å­—æ®µåšå¤æ‚æŸ¥è¯¢å¯èƒ½è¾ƒæ…¢
```

### 4. åˆ†é¡µæœ€ä½³å®è·µ

```go
// æ¸¸æ ‡åˆ†é¡µï¼ˆæ¨èï¼‰
filter := &session.EventFilter{
    StartTime: lastEventTime,  // ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€åä¸€ä¸ªäº‹ä»¶æ—¶é—´
    Limit:     100,
}

// Offset åˆ†é¡µï¼ˆç®€å•ä½†æ…¢ï¼‰
filter := &session.EventFilter{
    Limit:  100,
    Offset: 200,  // ç¬¬3é¡µï¼Œè·³è¿‡å‰200æ¡
}
```

## ğŸ” å®‰å…¨æœ€ä½³å®è·µ

### 1. æ•°æ®åº“æƒé™æœ€å°åŒ–

```sql
-- PostgreSQL: åˆ›å»ºä¸“ç”¨ç”¨æˆ·
CREATE USER agentsdk_app WITH PASSWORD 'strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON sessions, session_events TO agentsdk_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO agentsdk_app;

-- MySQL: åˆ›å»ºä¸“ç”¨ç”¨æˆ·
CREATE USER 'agentsdk_app'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON agentsdk.* TO 'agentsdk_app'@'%';
FLUSH PRIVILEGES;
```

### 2. SSL/TLS è¿æ¥

```go
// PostgreSQL SSL
DSN: "host=db.example.com port=5432 user=user dbname=db sslmode=require"

// MySQL SSL
DSN: "user:pwd@tcp(db.example.com:3306)/db?tls=custom"
```

### 3. æ•æ„Ÿæ•°æ®åŠ å¯†

```go
// å­˜å‚¨å‰åŠ å¯†æ•æ„Ÿå†…å®¹
event := &session.Event{
    Content: types.Message{
        Role:    types.RoleUser,
        Content: encrypt(sensitiveContent),  // åŠ å¯†
    },
    Metadata: map[string]interface{}{
        "ip": hashIP(clientIP),  // å“ˆå¸ŒåŒ–
    },
}
```

### 4. æ•°æ®ä¿ç•™ç­–ç•¥

```go
// å®šæœŸæ¸…ç†å†å²æ•°æ®
func cleanupOldSessions(service SessionService) {
    cutoffTime := time.Now().Add(-30 * 24 * time.Hour) // 30å¤©å‰

    sessions, _ := service.List(ctx, &session.ListFilter{
        EndTime: cutoffTime,
        Status:  session.StatusCompleted,
        Limit:   1000,
    })

    for _, sess := range sessions {
        service.Delete(ctx, sess.ID)
    }
}
```

## ğŸ“Š æ•°æ®åº“é€‰æ‹©æŒ‡å—

### PostgreSQL vs MySQL

| ç‰¹æ€§ | PostgreSQL | MySQL 8.0+ | è¯´æ˜ |
|------|-----------|-----------|------|
| **JSON æŸ¥è¯¢** | âœ… ä¼˜ç§€ (JSONB) | âœ… è‰¯å¥½ (JSON) | PG çš„ JSONB æ€§èƒ½æ›´å¥½ |
| **å…¨æ–‡æœç´¢** | âœ… å†…ç½® | âš ï¸ éœ€é…ç½® | PG å¼€ç®±å³ç”¨ |
| **å¤æ‚æŸ¥è¯¢** | âœ… å¼ºå¤§ | âœ… è‰¯å¥½ | PG æ”¯æŒæ›´å¤šé«˜çº§ç‰¹æ€§ |
| **å¹¶å‘æ€§èƒ½** | âœ… MVCC | âœ… InnoDB | éƒ½æ”¯æŒé«˜å¹¶å‘ |
| **ç”Ÿæ€æˆç†Ÿåº¦** | âœ… æ´»è·ƒ | âœ… æ´»è·ƒ | ä¸¤è€…éƒ½å¾ˆæˆç†Ÿ |
| **äº‘æœåŠ¡æ”¯æŒ** | âœ… å¹¿æ³› | âœ… å¹¿æ³› | AWSã€GCPã€Azure éƒ½æ”¯æŒ |
| **éƒ¨ç½²æˆæœ¬** | ğŸ’° ä¸­ | ğŸ’° ä½ | MySQL éƒ¨ç½²ç¨ç®€å• |

**æ¨èå†³ç­–**:
- âœ… **é€‰æ‹© PostgreSQL**: éœ€è¦å¤æ‚ JSON æŸ¥è¯¢ã€å…¨æ–‡æœç´¢ã€é«˜çº§åˆ†æ
- âœ… **é€‰æ‹© MySQL**: å·²æœ‰ MySQL åŸºç¡€è®¾æ–½ã€ç®€å•æŸ¥è¯¢ä¸ºä¸»ã€æˆæœ¬æ•æ„Ÿ

## ğŸ”— ä¸å·¥ä½œæµ Agent é›†æˆ

Session æŒä¹…åŒ–ä¸å·¥ä½œæµ Agent æ— ç¼é›†æˆï¼š

```go
// åˆ›å»º Session
sess, _ := sessionService.Create(ctx, &session.CreateRequest{
    AppName: "workflow-demo",
    UserID:  userID,
    AgentID: "pipeline-agent",
})

// æ‰§è¡Œå·¥ä½œæµï¼Œè‡ªåŠ¨æŒä¹…åŒ–äº‹ä»¶
sequential, _ := workflow.NewSequentialAgent(workflow.SequentialConfig{
    Name: "DataPipeline",
    SubAgents: []workflow.Agent{collector, analyzer, reporter},
})

for event, err := range sequential.Execute(ctx, "å¤„ç†æ•°æ®") {
    // è¿½åŠ äº‹ä»¶åˆ°æ•°æ®åº“
    sessionService.AppendEvent(ctx, sess.ID, &event)

    // äº‹ä»¶åŒ…å«ä¸°å¯Œçš„å·¥ä½œæµå…ƒæ•°æ®
    step := event.Metadata["sequential_step"]
    branch := event.Branch  // "DataPipeline.Analyzer"
}

// æ›´æ–° Session çŠ¶æ€
sess.Status = session.StatusCompleted
sessionService.Update(ctx, sess)
```

## ğŸ“š ç›¸å…³èµ„æº

- [Session æŒä¹…åŒ–ç¤ºä¾‹](/examples/session) - PostgreSQL å’Œ MySQL å®Œæ•´ç¤ºä¾‹
- [å·¥ä½œæµ Agent](/core-concepts/workflow-agents) - ä¸å·¥ä½œæµé›†æˆ
- [æ€§èƒ½ä¼˜åŒ–](/best-practices/performance) - æ•°æ®åº“æ€§èƒ½è°ƒä¼˜
- [å®‰å…¨æœ€ä½³å®è·µ](/best-practices/security) - æ•°æ®å®‰å…¨ç­–ç•¥

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•ä»å†…å­˜å­˜å‚¨è¿ç§»åˆ° PostgreSQLï¼Ÿ

A: ä½¿ç”¨æ‰¹é‡æ“ä½œè¿ç§»æ•°æ®ï¼š

```go
// ä»å†…å­˜è¯»å–
memSessions := memStore.ListSessions()

// æ‰¹é‡å†™å…¥ PostgreSQL
for _, sess := range memSessions {
    pgService.Create(ctx, sess)

    events := memStore.GetEvents(sess.ID)
    pgService.AppendEvents(ctx, sess.ID, events)
}
```

### Q2: å¦‚ä½•å¤„ç†å¤§é‡äº‹ä»¶çš„æŸ¥è¯¢ï¼Ÿ

A: ä½¿ç”¨æµå¼åˆ†é¡µæŸ¥è¯¢ï¼š

```go
offset := 0
limit := 1000

for {
    events, _ := service.GetEvents(ctx, sess.ID, &session.EventFilter{
        Limit:  limit,
        Offset: offset,
    })

    if len(events) == 0 {
        break
    }

    processEvents(events)
    offset += limit
}
```

### Q3: æ”¯æŒäº‹åŠ¡å—ï¼Ÿ

A: æ˜¯çš„ï¼Œæ‰¹é‡æ“ä½œè‡ªåŠ¨ä½¿ç”¨äº‹åŠ¡ï¼š

```go
// AppendEvents å†…éƒ¨ä½¿ç”¨äº‹åŠ¡
service.AppendEvents(ctx, sess.ID, events)  // å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥
```

### Q4: å¦‚ä½•ç›‘æ§æ•°æ®åº“æ€§èƒ½ï¼Ÿ

A: æ£€æŸ¥è¿æ¥æ± çŠ¶æ€ï¼š

```go
stats := service.DB().Stats()
fmt.Printf("Open=%d Idle=%d InUse=%d WaitCount=%d\n",
    stats.OpenConnections,
    stats.Idle,
    stats.InUse,
    stats.WaitCount)
```

### Q5: æ•°æ®å¦‚ä½•å¤‡ä»½ï¼Ÿ

```bash
# PostgreSQL
pg_dump -h localhost -U postgres agentsdk > backup-$(date +%Y%m%d).sql

# MySQL
mysqldump -h 127.0.0.1 -u root -p agentsdk > backup-$(date +%Y%m%d).sql
```

## ğŸš€ ä¸‹ä¸€æ­¥

- [å¼€å§‹ä½¿ç”¨ Session æŒä¹…åŒ–](/examples/session) - å®Œæ•´ä»£ç ç¤ºä¾‹
- [å·¥ä½œæµ Agent](/core-concepts/workflow-agents) - æŒä¹…åŒ–å·¥ä½œæµçŠ¶æ€
- [éƒ¨ç½²æŒ‡å—](/best-practices/deployment) - ç”Ÿäº§ç¯å¢ƒé…ç½®
- [æ€§èƒ½è°ƒä¼˜](/best-practices/performance) - æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥
